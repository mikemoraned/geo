+++
title = "Spelunking inside Overture Maps"
date = 2025-02-14

[extra]
+++

I went to another great [GeoMob Edinburgh][geomob] event a couple of weeks ago. It wasn't featured as a talk that evening, 
but in the chat after I heard a bit about [Overture Maps](https://overturemaps.org) from Ed Freyfogle.

I decided to go "spelunking". Don't take any of the following as advice ðŸ™‚, but rather as me just recording my explorations
so far.

Overture Maps are quite clear that they are [building on top of](https://overturemaps.org/about/faq/) other datasets, 
not replacing them. You can get a sense of what is available using their 
[Explore Tool](https://explore.overturemaps.org/#15/55.94461/-3.19177), but they also make the data queryable in a very
cloud-native form. 

I'd been also wanting to give DuckDB a go, so I tried that [option](https://docs.overturemaps.org/getting-data/duckdb/). 
The first thing you need to do is to install an load the `SPATIAL` extension:

```sql
INSTALL spatial;
LOAD spatial;
```

This extension needs to be loaded every time DuckDB starts, and I think there is a way to automate that, but for now I 
just type it in manually each time I connect to the DB.

Note that if you *accidentally* forget that then you can get stuck with a `BLOB` column. You can still re-interpret it 
into geo e.g. via
```sql
SELECT ST_GeomFromWKB(geometry) AS geometry2, *
FROM division_area_subset
LIMIT 10
```

However, I recommend ensuring `spatial` is loaded ðŸ™‚.

For my next phase of work on my [Biscuits](@/posts/2024-10-01.md) project I am most interested in boundaries of cities
and how they overlap with water areas. These correspond to the [`division_area`](https://docs.overturemaps.org/schema/reference/divisions/division_area/)
and [`water`](https://docs.overturemaps.org/schema/reference/base/water/) subsets.

There is a lot of data there, and my puny home network connection only goes so far, so I decided to restrict it to the
types I want to look at:

```sql
CREATE OR REPLACE TABLE division_area_subset AS
SELECT
    *
FROM
read_parquet(
's3://overturemaps-us-west-2/release/2025-01-22.0/theme=divisions/type=division_area/*',
hive_partitioning=1)
WHERE
    subtype IN ['county','locality']
```

If this takes too long, you can limit it further to different countries e.g.

```sql
CREATE OR REPLACE TABLE division_area_subset AS
SELECT
    *
FROM
read_parquet(
's3://overturemaps-us-west-2/release/2025-01-22.0/theme=divisions/type=division_area/*', 
hive_partitioning=1)
WHERE
    subtype IN ['county','locality'] AND country IN ['NL','GB']
```

For the water areas, I found it easier to use the `overturemaps` tool to get the geoparquet file:
```bash
overturemaps download -f geoparquet --type=water -o water_all.parquet
```
This is about 25G.

It can then be loaded into DuckDB:

```sql
CREATE OR REPLACE TABLE base_water AS
SELECT
    *
FROM
read_parquet('/<your full path>/water_all.parquet')
```

From there you can do a lot, but here's a selection of different things I tried.

```sql
SELECT names.primary,*
FROM division_area_subset3
WHERE names.primary LIKE '%sterdam%' 
      OR names.primary LIKE '%Edinburgh%'
      OR names.primary LIKE '%Glasgow%'
```

[geomob]: https://thegeomob.com/post/jan-28th-2025-geomobedi-details